<html>
    <head>
        <link href="./styles.css" rel="stylesheet"/>
    </head>
    <body>
        <div id="root">
            <h1 id="title">Traductor de Fields of Mistria</h1>
            <div id="menu">
                <span>
                    <label># línia </label>
                    <input id="lineIndex" type="number" placeholder="línia" min="0"/>
                </span>
                <span>
                    <label>Carregar fitxer local: </label>
                    <input type="file" id="loadFile" />
                </span>
                <span>
                    <a id="download-helper" hidden></a>
                    <button id="saveButton">GUARDAR</button>
                </span>
            </div>
            <div id="translator"></div>
            <div id="key-data"></div>
            <div id="screen-mock">
                <div id="dialog-section">
                    <div id="dialog-name">.</div>
                    <div id="dialog-text">L'Adeline's té moltes responsabilitats, però per sort té un munt de gent que li dona suport també. Com tu, [Ari]!</div>
                </div>
            </div>
        </div>
    </body>
    <script src="order.js"></script>
    <script type="text/javascript">
        function clamp(min,max,val) { return Math.min(Math.max(min,val), max) }

        function download(data, fileName) {
            const a = document.getElementById('download-helper')
            var json = JSON.stringify(data),
                blob = new Blob([json], {type: "octet/stream"}),
                url = window.URL.createObjectURL(blob)
            a.href = url
            a.download = fileName
            a.click()
            window.URL.revokeObjectURL(url)
        }

        let selectedRowIndex = 0

        let localized, original
        let isTranslated = {}
        function updateIsTranslated(lineKey){
            if(!(localized && original)){return}
            isTranslated[lineKey] = localized[lineKey] !== original[lineKey]
        }
    
        const lineIndex = document.getElementById("lineIndex")
        const uploadInput = document.getElementById('loadFile')
        const lineIndexInput = document.getElementById('lineIndex')
        const translator = document.getElementById("translator")
        const dialogText = document.getElementById("dialog-text")
        const keyData = document.getElementById("key-data")
        const saveButton = document.getElementById('saveButton')

        function translatorLine(nLine) { 
            const c = translator.children
            return [
                c[nLine*3],
                c[(nLine*3)+1],
                c[(nLine*3)+2],
            ]
        }
        
        let hasChanged = false
        saveButton.disabled = !hasChanged

        function onChangeTextArea(e) {
            const index = e.target.listIndex 
            const value = e.target.value
            const lineIndex = orderedLines[index + selectedRowIndex]
            localized[lineIndex] = value
            isTranslated[lineIndex] = value && value.length > 0
            updateIsTranslatedEmoji(index)
            onFocusTextArea(e)
            hasChanged = true
            saveButton.disabled = !hasChanged
        }

        function changeKeyData(e){
            const index = e.target.listIndex 
            const lineIndex = orderedLines[index + selectedRowIndex]
            keyData.innerText = lineIndex
        }

        function onFocusTextArea(e) {
            const newText = e.target.value
            dialogText.innerText = newText
        }

        function onKeyDownTextArea(e){
            const index = e.target.listIndex 
            if(e.code==="Tab"){
                if(!e.shiftKey && index == N_LINES_IN_SCREEN-1 && selectedRowIndex < MAX_LINE-1){
                    changeRowIndex(selectedRowIndex+1)
                    changeKeyData(e)
                    onFocusTextArea(e)
                    e.stopPropagation()
                    e.preventDefault()
                    return
                }
                if(e.shiftKey && index == 0 && selectedRowIndex > 0){
                    changeRowIndex(selectedRowIndex-1)
                    changeKeyData(e)
                    onFocusTextArea(e)
                    e.stopPropagation()
                    e.preventDefault()
                    return
                }
            }
        }

        function newTranslatorLine(index) {
            const originalLine = document.createElement("div")
            originalLine.className = "original-line"
            translator.appendChild(originalLine)
            originalLine.addEventListener('focus', changeKeyData)
            originalLine.listIndex = index
            const translatedLine = document.createElement("textarea")
            translatedLine.className = "translated-line"
            translatedLine.addEventListener('input', onChangeTextArea)
            translatedLine.addEventListener('focus', onFocusTextArea)
            translatedLine.addEventListener('focus', changeKeyData)
            translatedLine.addEventListener('keydown', onKeyDownTextArea)
            translatedLine.listIndex = index
            translator.appendChild(translatedLine)
            const isTranslated = document.createElement("div")
            isTranslated.className = "is-translated"
            translator.appendChild(isTranslated)
            isTranslated.addEventListener('focus', changeKeyData)
            isTranslated.listIndex = index
        }

        let N_LINES_IN_SCREEN = 17
        let MAX_LINE = 100 

        const KEY_COMMANDS = {
            DOWN_ONE : [],
            UP_ONE : [],
            DOWN_PAGE : ["PageDown"],
            UP_PAGE : ["PageUp"],
            START: ["Home"],
            END: ["End"],
        }

        const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/daniel-giralt-len/fields-of-mistria-catalan-translation/refs/heads/main'

        function updateIsTranslatedEmoji(index) {
            const [,,isTranslatedHTMLElement] = translatorLine(index)
            const lineIndex = orderedLines[selectedRowIndex + index]
            isTranslatedHTMLElement.innerText = isTranslated[lineIndex] ? "✔️" : "❌"
        }


        function changeRowIndex(newIndex) {
            selectedRowIndex = clamp(0,MAX_LINE-N_LINES_IN_SCREEN,newIndex)
            lineIndex.value = selectedRowIndex
            for(let i=0; i< N_LINES_IN_SCREEN; i++){
                const ii = selectedRowIndex + i
                const lineIndex = orderedLines[ii]
                const [untranslatedHTMLElement, translatedHTMLElement, isTranslatedHTMLElement] = translatorLine(i)
                untranslatedHTMLElement.innerHTML = original?.[lineIndex]
                untranslatedHTMLElement.className = lineIndex.endsWith('/init') ? "original-line is-init" : "original-line"
                translatedHTMLElement.value = isTranslated[lineIndex] ? localized?.[lineIndex] : ''
                translatedHTMLElement.placeholder = localized?.[lineIndex]
                updateIsTranslatedEmoji(i)
            }
        }

        
        for(let i=translator.children.length; i < N_LINES_IN_SCREEN*3; i=i+3){
            newTranslatorLine(i/3)
        }
        changeRowIndex(0)

        function updateInputs() {
            const keys = Object.keys(localized)
            isTranslated={}
            keys.map(updateIsTranslated)
            MAX_LINE = keys.length
            changeRowIndex(selectedRowIndex)
        }

        Promise.all([
            fetch(`${GITHUB_BASE_URL}/localization_eng.json`).then(response=>response.json()).then(json=>json.eng),
            fetch(`${GITHUB_BASE_URL}/localization.json`).then(response=>response.json().then(json=>json.eng))
        ])
        .then(function (jsons) {
            [original, localized] = jsons
            updateInputs()
        })
        .catch(function (err) {
            console.log('error: ' + err);
        })

        document.addEventListener("wheel", (event) => {
            changeRowIndex(Math.ceil(selectedRowIndex+event.deltaY/100))
        });
        
        document.addEventListener("keydown", (event) => {
            const code = event.code
            
            if(KEY_COMMANDS.DOWN_PAGE.includes(code)){ changeRowIndex(selectedRowIndex+N_LINES_IN_SCREEN) }
            else if(KEY_COMMANDS.UP_PAGE.includes(code)){ changeRowIndex(selectedRowIndex-N_LINES_IN_SCREEN) }
            else if(KEY_COMMANDS.UP_ONE.includes(code)){ changeRowIndex(selectedRowIndex-1) }
            else if(KEY_COMMANDS.DOWN_ONE.includes(code)){ changeRowIndex(selectedRowIndex+1) }
            else if(KEY_COMMANDS.START.includes(code)){ changeRowIndex(0) }
            else if(KEY_COMMANDS.END.includes(code)){ changeRowIndex(MAX_LINE) }
        });

        saveButton.addEventListener('click', ()=>{
            hasChanged = false
            saveButton.disabled = !hasChanged
            download(localized, "localization.json")
        })

        uploadInput.addEventListener('change', () => {
            let file = uploadInput.files[0]

            const reader = new FileReader();
            reader.onload = () => {
                localized = JSON.parse(reader.result)
                updateInputs()
            };
            reader.onerror = () => {
                showMessage("Error reading the file. Please try again.", "error");
            };
            reader.readAsText(file)
        })
        lineIndexInput.addEventListener('input', (e)=>{ 
            changeRowIndex(Number(e.target.value))
        })

        window.onbeforeunload = function() {
            return hasChanged ? "Potser tinguis dades per a guardar, segur que vols sortir? Perdràs els canvis." : undefined
        }
    </script>
</html>